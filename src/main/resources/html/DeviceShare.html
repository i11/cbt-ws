<html>

<head>
<title>User Test management page</title>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="/jqueryui/ui/jquery-ui.js"></script>
<script src="/js/cbtclient.js"></script>
<script src="/js/common.js"></script>
<script src="/js/md5.js"></script>
<script src="/js/purl.js"></script>
</head>

<body onload="onLoad();">

	<script type="text/javascript">
		function onLoadPageSpecific() {
			var deviceId = $.url().param('deviceId');
			$("#title").append("Sharing setting for device id:" + deviceId);
			var currentlySharedWith;
			// Get exsiting sharing settings
			$.ajax({
				type : 'GET',
				url : rootURL + '/device/' + deviceId + "/share",
				dataType : "json",
				success : function(json) {
					currentlySharedWith = json;
					$.each(json, function(i, data) {						
						$("#sharedwith").append('<li>' + data.name + '</li>');
					});					
				}
			});
			
			// Produce list of users
			$.ajax({
				type : 'GET',
				url : rootURL + '/user',
				dataType : "json",
				success : function(json) {					
					$.each(json, function(i, data) {
						var alreadyShared = false;
						for(var i = 0; i < currentlySharedWith.length; i++) {
						    if (currentlySharedWith[i].user_id == data.user_id) {
						    	alreadyShared = true;
						        break;
						    }
						}
						if (!alreadyShared) {
							$("#users").append('<option value="' + data.user_id + '">' + data.name +'</option>');
						}
					});					
				}
			});
			
			$("button.add").button().click(function(event) {
				var userId = $("#users").val();
				console.log("Add sharing for device id:" + deviceId + " user:" + userId);
				$.ajax({
					type : 'PUT',
					url : rootURL + '/device/' + deviceId + '/share/' + userId,
					dataType : "json",
					statusCode: {
					    204: function() {
					      alert("Share added");
					    }
					},
					error: function() { alert("Server error"); }
				});
			});
		}
	</script>

	<div id="header"></div>

	<div id="contents">
		<div id="title"></div>		
		
		Select user 
		<select id="users">
		</select>
		<button class="add" value="">Run</button>		
		
		<br />
		Currently shared with:
		<ul id="sharedwith">
		</ul>
	</div>
</body>
</html>